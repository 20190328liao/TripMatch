@using System.Security.Claims
@{
    ViewData["Title"] = "會員中心";
    Layout = "~/Views/Shared/_LoginLayout.cshtml";

    var avatarUrl = User.FindFirst("Avatar")?.Value;
    if (string.IsNullOrEmpty(avatarUrl))
    {
        avatarUrl = Url.Content("~/img/default_avatar.png");
    }

    var currentUserId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "0";
}

<div class="member_center_wrap">

    <!-- =============================================
         區塊一：個人資料
         ============================================= -->
    <section class="member_section" id="profile_section">
        <h2 class="titleWrap titleH2">個人資料</h2>

        <!-- 通知列 -->
        <div class="notification_bar">
            <i class="bi bi-bell"></i>
        </div>

        <div class="profile_container row g-4">
            @* g-4 增加左右間距 *@

            <div class="profile_avatar_section col-12 col-md-6 d-flex flex-column align-items-center justify-content-center">
                <div class="avatar_frame">
                    <img src="@avatarUrl" alt="會員頭像" id="memberAvatar" class="memberAvatar">
                </div>
                <input type="file" id="avatarInput" accept="image/jpeg,image/png,image/gif,image/webp"
                       style="position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden;" />

                <div class="avatar_btns mt-3">
                    <button type="button" class="btn btn_light btn-sm" id="btnEditAvatar">編輯頭像</button>
                </div>
                    <button type="button" class="btn btn_Gray btn-sm" id="btnLogout">登 出</button>
            </div>

            <div class="profile_info_section col-12 col-md-6">
                <div class="info_row">
                    <div class="info_item mb-4">
                        <label class="info_label"><i class="bi bi-square-fill text-success me-2"></i>帳號｜主要信箱</label>
                        <div class="info_value d-flex align-items-center gap-2">
                            <span id="displayEmail">example@gmail.com</span>
                            <input id="inputEmail" type="email" class="form-control d-none" />
                            <button id="btnResetEmail" class="btn btn_Gray p-0">換信箱重設帳戶</button>
                        </div>
                    </div>
                </div>

                <div class="info_row">
                    <div class="info_item mb-4">
                        <label class="info_label"><i class="bi bi-square-fill text-warning me-2"></i>備援信箱</label>
                        <div class="info_value d-flex align-items-center gap-2">
                            <span id="displayBackupEmail">example2@gmail.com</span>
                            <input id="inputBackupEmail" type="email" class="form-control d-none" />
                            <button id="btnEditBackupEmail" class="btn btn_link edit_link p-0">編輯</button>
                            <button id="btnSaveBackupEmail" class="btn btn_light btn-sm d-none">寄驗證信</button>
                            <button id="btnCancelBackupEmail" class="btn btn_light btn-sm d-none">取消</button>
                        </div>
                    </div>
                    <div class="info_item">
                        <label class="info_label"><i class="bi bi-square-fill text-warning me-2"></i>修改密碼</label>
                        <div>
                            <a href="@Url.Action("ChangePassword", "Auth")" class="edit_link">前往修改</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- =============================================
         區塊二：個人行事曆
         ============================================= -->
    <section class="member_section" id="calendar_section">
        <h2 class="titleWrap titleH2">個人行事曆</h2>

        <div class="calendar_legend mb-3">
            <span class="legend-item"><span class="dot today"></span>藍色圈：今天</span>
            <span class="legend-item"><span class="dot locked"></span>灰色圈：已有行程（不可選）</span>
            <span class="legend-item"><span class="dot range"></span>淡藍綠色圈（開始：粉藍；結束：橘）：範圍選擇</span>
            <span class="legend-item"><span class="dot ok"></span>藍綠色：舊提交</span>
            <span class="legend-item"><span class="dot ok2"></span>深藍色：新提交</span>
            <span class="legend-item" id="CalendarHint">會員如果需要單日，則日期點兩下</span>
        </div>

        <div class="container">
            <div class="row g-3 align-items-start">
                <!-- 左：月份選擇器 -->
                <div class="col-sm-12 col-md-3 months-panel">
                    <header class="year-header d-flex justify-content-between align-items-center">
                        <button class="year-left btn btn-sm btn-link">◀</button>
                        <div class="year-display">2026</div>
                        <button class="year-right btn btn-sm btn-link">▶</button>
                    </header>

                    <div class="months-grid mt-2"></div>
                </div>

                <!-- 中：日曆 -->
                <div class="col-sm-12 col-md-6 month-panel">
                    <header class="month-header d-flex justify-content-between align-items-center">
                        <button class="month-left btn btn-sm btn-link">◀</button>
                        <div class="month-display">January 2026</div>
                        <button class="month-right btn btn-sm btn-link">▶</button>
                    </header>

                    <div class="week mt-2 d-flex justify-content-between small text-muted">
                        <div>週一</div>
                        <div>週二</div>
                        <div>週三</div>
                        <div>週四</div>
                        <div>週五</div>
                        <div>週六</div>
                        <div>週日</div>
                    </div>

                    <div class="days mt-2"></div>

                    <div class="display-selected mt-3">
                        <p class="selected"></p>
                    </div>
                </div>

                <!-- 右：清單（草稿 + 已提交） -->
                <aside class="col-sm-12 col-md-3 list-panel">
                    <div class="list-header mb-2">
                        <h5 class="mb-0">目前選擇</h5>
                        <small class="text-muted">提示</small>
                    </div>

                    <div id="calendarList" class="calendar-list" aria-live="polite" role="region">
                        @* 由 Calendar.js 填入，每列格式如 "2026年1月1日" *@
                    </div>
                </aside>
            </div>

            @* 共用按鈕放在底部一列，手機會縮滿寬度 *@
            <div class="row mt-3">
                <div class="col-12 d-flex gap-2 flex-wrap">
                    <button class="confirm btn btn-primary">提交</button>
                    <button class="edit btn btn-secondary">開始編輯</button>
                    <button class="btn-delete btn btn-outline-danger">刪除</button>
                </div>
            </div>
        </div>
    </section>

    <!-- =============================================
         區塊三：願望清單
         ============================================= -->
    <section class="member_section" id="wishlist_section">
        <div class="section_header d-flex align-items-center justify-content-between">
            <h2 class="titleWrap titleH2">願望清單</h2>
            <div href="#" class="edit_cards_link"><i class="bi bi-pencil-square me-1"></i>點擊卡片編輯 ▼</div>
        </div>

        <div class="mb-3">
            <button id="btnSeedWishlist" class="btn btn-sm btn-outline-primary"
                    data-userid="@currentUserId" data-tripid="2">
                生成假資料（User=@currentUserId, Trip=2）
            </button>
        </div>

        <!-- 願望清單卡片容器：由 wishlist.js 動態塞入 -->
        <div class="wishlist_cards_container row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-3"
             id="wishlistCardsContainer"
             aria-live="polite" role="region" aria-label="使用者願望清單">
        </div>

        @* 全域的 View more 連結移除（每張卡片會由前端產生其 own View more） *@
    </section>

</div>
<a href="@Url.Action("Index", "Home")" class="back-home-link">
    回到首頁
</a>

@section Styles {
}

@section Scripts {
    <script src="~/js/AuthApi/Datehelper.js" asp-append-version="true"></script>
    <script src="~/js/AuthApi/Calendar.js" asp-append-version="true"></script>
    <script src="~/js/AuthApi/wishlist.js" asp-append-version="true"></script>
    <script src="~/js/AuthApi/memberCenter.js" asp-append-version="true"></script>
    <script src="~/js/AuthApi/logout.js" asp-append-version="true"></script>

    <script>
        // 生成假資料按鈕行為：呼叫 API /api/MemberCenterApi/SeedDummyWishlistForTrip
        document.addEventListener('DOMContentLoaded', function () {
            const btn = document.getElementById('btnSeedWishlist');
            if (!btn) return;
            btn.addEventListener('click', async function () {
                const userId = parseInt(btn.getAttribute('data-userid'), 10) || 0;
                const tripId = parseInt(btn.getAttribute('data-tripid'), 10) || 0;
                if (!userId || !tripId) { alert('缺少 userId 或 tripId'); return; }
                if (!confirm(`確定為 user ${userId}、trip ${tripId} 產生假資料？`)) return;

                try {
                    const res = await fetch('/api/MemberCenterApi/SeedDummyWishlistForTrip', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: userId, tripId: tripId })
                    });
                    const json = await res.json();
                    if (res.ok) {
                        alert('已建立假資料，將重新載入願望清單');
                        if (window.reloadWishlist) {
                            window.reloadWishlist();
                        } else {
                            location.reload();
                        }
                    } else {
                        alert('建立假資料失敗：' + (json?.message ?? JSON.stringify(json)));
                    }
                } catch (ex) {
                    console.error('SeedDummyWishlistForTrip failed', ex);
                    alert('建立假資料時發生例外，請查看 console');
                }
            });
        });
    </script>
}


