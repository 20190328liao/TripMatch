@model TripMatch.Models.DTOs.MyTripsDto
@{
    ViewData["Title"] = "我的行程";
    Layout = "~/Views/Shared/_Layout-copy.cshtml";
    var taggedUserId = ViewBag.TaggedUserId as int?;
}

@* 1. 頁面專屬 CSS 區塊 *@
@section Styles {
    <link rel="stylesheet" href="~/css/trip/trip.css" />
}

@if (TempData["UnauthorizedMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show mt-3 d-flex align-items-center justify-content-between" role="alert">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <span>@TempData["UnauthorizedMessage"]</span>
        </div>
        <button type="button" class="btn-close custom-alert-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="container">
    <div class="mytrip-header">
        <h1 class="mytrip-title memberTitle mb-0 titleWrap titleH2"><span class="current-title"></span>我的行程</h1>
        <a asp-controller="Trip" asp-action="Create" class="create-btn">
            + 建立新旅程
        </a>
    </div>

    <!-- 測試行程有沒有進來 -->
    <div style="margin:12px 0; color:#111; font-weight:700;">
        共 @(Model?.Trips?.Count ?? -1) 個行程
        @* <p>Current tagged UserId: <strong>@taggedUserId.Value</strong></p> *@
    </div>
    <!-- 測試圖片url -->
    @* @foreach (var t in Model.Trips)
    {
        <div style="font-size:12px;color:red">
            @t.CoverImageUrl
        </div>
    } *@
    

    <!-- 已開團 -->
    <h2 class="section-title">已開團</h2>

    @if(Model.Trips == null || !Model.Trips.Any())
    {
        <div class="empty-hint">目前沒有已開團行程</div>
    }
    else
    {
        <div class="grid">
            @foreach(var t in Model.Trips)
            {
                var dataText = $"{t.StartDate:yyyy/MM/dd} - {t.EndDate:yyyy/MM/dd}";
                <article class="card"
                         data-trip-id="@t.TripId"
                         data-details-url="@t.DetailsUrl"
                         data-is-owner="@(t.IsOwner ? "1" : "0")">

                    <div class="card-cover"
                         style="background-image:url(@t.CoverImageUrl);">

                    </div>

                    <div class="card-body">
                        <div class="card-title">@t.Title</div>
                        <div class="card-meta">
                            <div class="card-date">@dataText</div>
                            <div class="member-pill">@(t.MemberCount)人</div>
                        </div>
                    </div>

                    <div class="card-actions">
                        <button type="button" class="kebab-btn" aria-label="更多">
                            <span class="kebab-dot"></span>
                            <span class="kebab-dot"></span>
                            <span class="kebab-dot"></span>
                        </button>

                        <div class="menu" role="menu">
                            <button type="button" class="menu-item" data-action="members">成員</button>
                            <button type="button" class="menu-item danger" data-action="danger">
                                @(t.IsOwner ? "刪除" : "退出")
                            </button>
                        </div>
                    </div>

                </article>
            }
        </div>
    }
    <!-- 媒合中 -->
    <h2 class="section-title mt-24">媒合中</h2>

    @if(Model.MatchingGroups == null || !Model.MatchingGroups.Any())
    {
        <div class="empty-hint">沒有媒合中的行程</div>
    }
    else
    {
        <div class="grid">
            @foreach(var g in Model.MatchingGroups)
            {
                <article class="card"
                    data-kind="matching"
                    data-group-id="@g.GroupId"
                    data-status="@g.Status"
                    data-details-url="@g.DetailsUrl">

                    @* 圖片 *@
                    <div class="card-cover" style="background-image:url(@g.CoverImageUrl);"></div>
                    
                    <div class="card-body">
                        <div class="card-title">@g.Title</div>
                        @* 狀態小字 *@
                        <div class="card-sub">@g.Status</div>
                    </div>

                </article>
            }
        </div>
    }
</div>

<!-- Members Modal -->
<div id="membersModal" class="modal-backdrop" hidden>
    <div class="myModal">
        <div class="modal-header">
            <h3>行程成員</h3>
            <button class="modal-close" aria-label="關閉">×</button>
        </div>

        <div class="modal-body">
            <ul id="membersList"></ul>
            <hr class="modal-divider" />
            <!-- 邀請碼區域 -->
            <div class="invite-row">
                <div class="invite-label">邀請碼</div>

                <div class="invite-line">
                    <div class="inviteCodeShell" aria-label="橫向捲動邀請連結">
                        <code id="inviteCodetext" class="invite-code" title="">載入中...</code>
                    </div>
                    
                    <button type="button" id="btnCopyInvite" class="invite-btn invite-btn-copy" disabled>copy</button>
                </div>
                <div id="inviteHint" class="invite-hint"></div>
            </div>

        </div>
        @* <div class="modal-footer">
            <button type="button" class="invite-btn invite-btn-close">關閉</button>
        </div> *@
    </div>
</div>










@section Scripts {
    <script src="~/js/trip/trip.js" asp-append-version="true"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 找到頁面上的 alert 元素
            const alertElement = document.querySelector(".alert");

            if (alertElement) {
                // 設定 5000 毫秒 (5秒) 後執行
                        setTimeout(() => {
            const alert = document.querySelector(".alert");
            if (alert) {
                alert.style.transition = "opacity 0.5s ease";
                alert.style.opacity = "0";
                setTimeout(() => alert.remove(), 500); // 變透明後再從 DOM 移除
            }
        }, 10000);
            }
        });
    </script>
}