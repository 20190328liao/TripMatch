@model TripMatch.Models.DTOs.TimeWindow.PreferencesViewModel
@using Microsoft.Extensions.Configuration
@inject IConfiguration Configuration
@{
	ViewData["Title"] = "團隊規劃";
	Layout = "~/Views/Shared/_Layout-copy.cshtml";
}

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>@ViewData["Title"]</title>
	<style>
		:root {
			--bg-color: #F3F8FF;
			--card-bg: #FFFFFF;
			--primary-blue: #155DFC;
			--primary-blue-hover: #104AB8;
			--text-main: #111827;
			--text-sub: #6B7280;
			--border-color: #E5E7EB;
			--success-green: #16A34A;
			--shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
			--radius-card: 16px;
			--radius-btn: 12px;
			--font-family: system-ui, -apple-system, sans-serif;
		}

		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}

		body {
			background-color: var(--bg-color);
			font-family: var(--font-family);
			color: var(--text-main);
			padding-bottom: 40px;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 0 24px;
		}

		.icon {
			width: 20px;
			height: 20px;
			display: inline-block;
			vertical-align: middle;
			stroke-width: 2;
		}

		.app-bar {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 20px 0;
			margin-bottom: 10px;
		}

		.back-link {
			text-decoration: none;
			color: var(--text-main);
			font-weight: 600;
			display: flex;
			align-items: center;
			gap: 6px;
		}

		.btn {
			display: inline-flex;
			align-items: center;
			gap: 8px;
			padding: 10px 20px;
			border-radius: var(--radius-btn);
			border: none;
			font-weight: 600;
			cursor: pointer;
			transition: 0.2s;
			white-space: nowrap;
		}

		.btn-primary {
			background-color: var(--primary-blue);
			color: white;
		}

			.btn-primary:hover {
				background-color: var(--primary-blue-hover);
			}

		.btn-success {
			background-color: var(--success-green);
			color: white;
		}

		.header-card {
			background: var(--card-bg);
			border-radius: var(--radius-card);
			box-shadow: var(--shadow);
			padding: 24px 32px;
			display: flex;
			flex-wrap: wrap;
			justify-content: space-between;
			align-items: center;
			gap: 20px;
			margin-bottom: 30px;
		}

		.header-info h1 {
			font-size: 24px;
			font-weight: 700;
			margin-bottom: 8px;
		}

		.invite-code {
			color: var(--text-sub);
			font-size: 14px;
		}

			.invite-code span {
				color: var(--primary-blue);
				font-weight: 600;
				text-decoration: underline;
				cursor: pointer;
			}

		.header-stats {
			display: flex;
			gap: 32px;
			align-items: center;
		}

		.stat-item {
			text-align: center;
		}

		.stat-num {
			font-size: 24px;
			font-weight: 800;
			line-height: 1.2;
		}

		.status-badge {
			background-color: #FEF3C7;
			color: #B45309;
			padding: 6px 16px;
			border-radius: 99px;
			font-weight: 600;
			font-size: 14px;
		}

		.tabs-container {
			display: flex;
			justify-content: center;
			background: var(--card-bg);
			padding: 6px;
			border-radius: 99px;
			box-shadow: 0 1px 3px rgba(0,0,0,0.05);
			margin-bottom: 30px;
			max-width: 500px;
			margin-left: auto;
			margin-right: auto;
		}

		.tab-btn {
			flex: 1;
			display: flex;
			gap: 8px;
			align-items: center;
			justify-content: center;
			padding: 12px 24px;
			border-radius: 99px;
			border: none;
			background: transparent;
			color: var(--text-sub);
			font-weight: 600;
			cursor: pointer;
			transition: 0.3s;
			font-size: 16px;
		}

			.tab-btn.active {
				background-color: var(--primary-blue);
				color: white;
				box-shadow: 0 4px 6px -1px rgba(21, 93, 252, 0.3);
			}

		.tab-content {
			display: none;
			animation: fadeIn 0.3s ease-in-out;
		}

			.tab-content.active {
				display: block;
			}

		@@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(5px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		/* Tab A */
		.input-group {
			display: flex;
			gap: 12px;
			margin-bottom: 32px;
			background: var(--card-bg);
			padding: 16px;
			border-radius: var(--radius-card);
			box-shadow: var(--shadow);
		}

		.input-field {
			flex: 1;
			padding: 12px 16px;
			border: 1px solid var(--border-color);
			border-radius: var(--radius-btn);
			font-size: 16px;
			outline: none;
		}

			.input-field:focus {
				border-color: var(--primary-blue);
				box-shadow: 0 0 0 3px rgba(21, 93, 252, 0.1);
			}

		.location-grid {
			display: grid;
			grid-template-columns: repeat(4, 1fr);
			gap: 20px;
		}

		.location-card {
			background: var(--card-bg);
			border: 2px solid var(--border-color);
			border-radius: var(--radius-card);
			padding: 20px;
			cursor: pointer;
			position: relative;
			transition: 0.2s;
			display: flex;
			flex-direction: column;
			justify-content: center;
			height: 120px;
		}

			.location-card:hover {
				border-color: #CBD5E1;
				transform: translateY(-2px);
			}

			.location-card.selected {
				border-color: var(--primary-blue);
				background-color: #EFF6FF;
				box-shadow: 0 0 0 1px var(--primary-blue);
			}

		.loc-city {
			font-size: 18px;
			font-weight: 700;
			margin-bottom: 4px;
			color: var(--text-main);
		}

		.loc-country {
			font-size: 14px;
			color: var(--text-sub);
		}

		.location-card:hover {
			opacity: 1;
		}

		/* Tab B */
		.pref-card {
			background: var(--card-bg);
			border-radius: var(--radius-card);
			box-shadow: var(--shadow);
			padding: 32px;
			max-width: 800px;
			margin: 0 auto;
		}

		.pref-header {
			display: flex;
			align-items: center;
			gap: 12px;
			margin-bottom: 24px;
			padding-bottom: 16px;
			border-bottom: 1px solid var(--border-color);
		}

		.form-group {
			margin-bottom: 24px;
		}

		.form-label {
			display: block;
			margin-bottom: 8px;
			font-weight: 600;
			font-size: 15px;
		}

		.required {
			color: #EF4444;
			margin-left: 4px;
		}

		.form-select {
			width: 100%;
			padding: 12px 16px;
			border: 1px solid var(--border-color);
			border-radius: var(--radius-btn);
			font-size: 16px;
			background-color: #fff;
			outline: none;
			cursor: pointer;
			appearance: none;
			background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236B7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
			background-repeat: no-repeat;
			background-position: right 16px center;
			background-size: 16px;
		}

		.btn-full {
			width: 100%;
			padding: 14px;
			font-size: 16px;
			border-radius: var(--radius-btn);
			margin-top: 10px;
		}

		@@media (max-width: 1024px) {
			.location-grid {
				grid-template-columns: repeat(3, 1fr);
			}
		}

		@@media (max-width: 768px) {
			.container {
				padding: 0 16px;
			}

			.header-card {
				flex-direction: column;
				align-items: flex-start;
			}

			.header-stats {
				width: 100%;
				justify-content: space-between;
				margin-top: 10px;
			}

			.tabs-container {
				width: 100%;
			}

			.input-group {
				flex-direction: column;
			}

			.location-grid {
				grid-template-columns: repeat(2, 1fr);
			}
		}

		@@media (max-width: 480px) {
			.location-grid {
				grid-template-columns: 1fr;
			}

			.app-bar .btn span {
				display: none;
			}
		}
	</style>
</head>
<body>
	<div class="container">
		<header class="app-bar">
			<a href="@Url.Action("Index", "Home")" class="back-link">
				<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
					<line x1="19" y1="12" x2="5" y2="12"></line>
					<polyline points="12 19 5 12 12 5"></polyline>
				</svg>
				返回首頁
			</a>
			<button type="button" class="btn btn-primary" onclick="goToCalendar()">
				<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
				<span>前往提交時間</span>
			</button>
		</header>

		<section class="header-card">
			<div class="header-info">
				<h1>團隊規劃討論</h1>
				<p class="invite-code">邀請碼：<span>@Model.InviteCode</span></p>
			</div>
			<div class="header-stats">
				<div class="stat-item">
					<span class="status-badge">偏好設定階段</span>
				</div>
			</div>
			<div class="stat-item">
				<div style="font-size: 12px; color: var(--text-sub); margin-bottom: 2px;">加入人數</div>
				<div class="stat-num">@Model.JoinedCount / @Model.TargetNumber</div>
			</div>

			<div class="stat-item">
				<div style="font-size: 12px; color: var(--text-sub); margin-bottom: 2px;">已提交</div>
				<div class="stat-num" style="color: @(Model.SubmittedCount == Model.JoinedCount ? "var(--success-green)" : "var(--primary-blue)")">
					@Model.SubmittedCount / @Model.TargetNumber
				</div>
			</div>
		</section>

		<nav class="tabs-container">
			<button class="tab-btn active" onclick="switchTab('tabA')" id="btn-tabA">
				<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
				候選地點
			</button>
			<button class="tab-btn" onclick="switchTab('tabB')" id="btn-tabB">
				<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
				個人偏好設定
			</button>
		</nav>

		<div id="tabA" class="tab-content active">
			<div style="margin-bottom: 24px;">
				<h2 style="font-size: 20px; font-weight: 700; margin-bottom: 6px;">候選地點池</h2>
				<p style="color: var(--text-sub); font-size: 15px;">請選擇想去的地點，系統將以此生成方案</p>
			</div>

			<div class="input-group">
				<input type="text"
					   id="newLocationInput"
					   class="input-field"
					   placeholder="輸入城市（例如：巴黎、紐約）"
					   autocomplete="off">

				<button type="button" class="btn btn-success" onclick="addCustomLocation()">
					新增
				</button>
			</div>

			<div id="locationGrid" class="location-grid">
				@if (Model.HotLocations != null && Model.HotLocations.Count > 0)
				{
					foreach (var loc in Model.HotLocations)
					{
						<div class="location-card" onclick="toggleSelection('@loc.City', this)" data-val="@loc.City">
							<div class="loc-country">@loc.City</div>
							<div class="loc-country">@loc.CountryCode</div>
						</div>
					}
				}
			</div>
		</div>

		<div id="tabB" class="tab-content">
			<div style="margin-bottom: 24px;">
				<h2 style="font-size: 20px; font-weight: 700; margin-bottom: 6px;">個人偏好設定</h2>
				<p style="color: var(--text-sub); font-size: 15px;">填寫您的個人偏好，系統將綜合所有成員意見進行推薦</p>
			</div>

			<div class="pref-card">
				<form id="prefForm" onsubmit="savePreferences(event)">
					<div class="form-group">
						<label class="form-label">飯店預算（每晚）<span class="required">*</span></label>
						<select id="budget" name="budget" class="form-select" required>
							<option value="" disabled selected>請選擇預算範圍</option>
							<option value="1000">NT$ 1,000 以下</option>
							<option value="2500">NT$ 2,500 左右</option>
							<option value="4000">NT$ 4,000 左右</option>
							<option value="5000">NT$ 5,000 以上</option>
						</select>
					</div>

					<div class="form-group">
						<label class="form-label">轉機偏好 <span class="required">*</span></label>
						<select id="transfer" name="transfer" class="form-select" required>
							<option value="" disabled selected>請選擇轉機偏好</option>
							<option value="true">可接受轉機</option>
							<option value="false">不可轉機（直飛）</option>
						</select>
					</div>

					<div class="form-group">
						<label class="form-label">飯店星等偏好 <span class="required">*</span></label>
						<select id="stars" name="stars" class="form-select" required>
							<option value="" disabled selected>請選擇星等</option>
							<option value="3">3 星級以上</option>
							<option value="4">4 星級以上</option>
							<option value="5">5 星級</option>
							<option value="flex">彈性 (無所謂)</option>
						</select>
					</div>
					<div class="form-group">
						<label class="form-label">個人行程總預算<span class="required">*</span></label>
						<input type="number" id="totalBudget" name="totalBudget" class="input-field" required placeholder="請輸入總預算 (NT$)">
					</div>

					<button type="submit" class="btn btn-primary btn-full" id="btnSubmit">
						儲存我的偏好
					</button>
				</form>
			</div>
		</div>
	</div>

	<script>
				// --- Google Places Autocomplete 相關變數 ---
		let autocomplete;

		// 這就是 Google API 載入完成後會呼叫的函式
					function initAutocomplete() {
			const input = document.getElementById("newLocationInput");
			if (!input) return;

			const options = {
				types: ['(cities)'],
				fields: ['name', 'geometry', 'address_components']
			};

			autocomplete = new google.maps.places.Autocomplete(input, options);

			autocomplete.addListener("place_changed", function() {
				const place = autocomplete.getPlace();
				if (!place.geometry || !place.geometry.location) return;

				// 1. 呼叫剛剛改好的函式抓國家名稱
				const countryName = getCountryName(place);

				input.value = place.name;

				// 2. ★ 把國家名稱暫存到 dataset.country 裡
				input.dataset.country = countryName;
			});
		}

		// ★ 新增這個 Helper 函式來解析 Google 的複雜結構
				// 修改這個 Helper 函式，改抓 long_name
		function getCountryName(place) {
			if (!place.address_components) return "";

			for (const component of place.address_components) {
				if (component.types.includes("country")) {
					// ★ 關鍵：改成 return long_name (例如 "Japan")
					return component.long_name;
				}
			}
			return ""; // 真的找不到才回傳空字串
		}

		const groupId = '@Model.GroupId';
		let selectedLocationNames = new Set();

		document.addEventListener("DOMContentLoaded", function() {

			const savedLocs = @Html.Raw(Json.Serialize(Model.MySelectedLocations));

			if (savedLocs && savedLocs.length > 0) {
				savedLocs.forEach(cityName => {
					selectedLocationNames.add(cityName);

					const existingCard = document.querySelector(`.location-card[data-val='${cityName}']`);

					if (existingCard) {
						existingCard.classList.add('selected');
					} else {
						restoreCustomCard(cityName);
					}
				});
				console.log("已還原地點:", Array.from(selectedLocationNames));
			}
		});

		function switchTab(tabId) {
			document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
			document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
			document.getElementById('btn-' + tabId).classList.add('active');
			document.getElementById(tabId).classList.add('active');
		}

		function toggleSelection(cityName, cardElement) {
			if (cardElement.classList.contains('selected')) {
				cardElement.classList.remove('selected');
				selectedLocationNames.delete(cityName);
			} else {
				cardElement.classList.add('selected');
				selectedLocationNames.add(cityName);
			}
			console.log("目前已選地點:", Array.from(selectedLocationNames));
		}

		function addCustomLocation() {
			const input = document.getElementById('newLocationInput');
			const cityName = input.value.trim();

			// ★ 關鍵：從 dataset 拿出 Google 查到的國家 (上一回合教您的 initAutocomplete 裡存的)
			// 如果 dataset 裡沒有 (例如使用者純手打沒選選單)，就維持 "自訂"
			const countryName = input.dataset.country || "自訂";

			if(!cityName) { alert("請輸入地點"); return; }

			// 呼叫剛剛改好的函式，把國家傳進去
			createAndAppendCard(cityName, countryName);

			// 清空輸入框
			input.value = "";
			input.dataset.country = "";
		}

		function restoreCustomCard(val) {
			// 直接呼叫 createAndAppendCard，它現在已經會自動處理 "City|Country" 的字串拆解了
			createAndAppendCard(val);
		}

				async function savePreferences(event) {
			event.preventDefault();

			// 1. 取得 DOM 元素值
			const budgetVal = document.getElementById('budget').value;
			const transferVal = document.getElementById('transfer').value;
			const starsVal = document.getElementById('stars').value;
			const totalBudgetVal = document.getElementById('totalBudget').value;

			// 2. 必填檢查
			if (!budgetVal || !transferVal || !starsVal || !totalBudgetVal) {
				alert("請完成所有必填選項！");
				return;
			}

			// 3. 資料轉換邏輯
			const hotelBudget = parseInt(budgetVal);
			const isTransfer = (transferVal === "true");
			const hotelRating = (starsVal === "flex") ? null : parseInt(starsVal);
			const placesString = Array.from(selectedLocationNames).join(",");
			const totalBudget = totalBudgetVal ? parseInt(totalBudgetVal) : null;

			// 4. 組裝 Payload
			const payload = {
				HotelBudget: hotelBudget,
				Transfer: isTransfer,
				HotelRating: hotelRating,
				PlacesToGo: placesString,
				TotalBudget: totalBudget
			};

			// 5. UI 鎖定與送出
			const btn = document.getElementById('btnSubmit');
			const originalText = btn.innerText;
			btn.disabled = true;
			btn.innerText = "儲存中...";

			try {
				const response = await fetch(`/api/timewindow/${groupId}/preferences`, {
					method: 'PUT',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(payload)
				});

				if (response.ok) {
					alert("偏好儲存成功！");
					window.location.href = `/Match/CalendarCheck/${groupId}`;
				} else {
					const errData = await response.json();
					alert("儲存失敗: " + (errData.message || "未知錯誤"));
					btn.disabled = false;
					btn.innerText = originalText;
				}
			} catch(e) {
				console.error(e);
				alert("網路連線錯誤，請稍後再試");
				btn.disabled = false;
				btn.innerText = originalText;
			}
		}

		// 共用的建立卡片邏輯
						// 修改後的 createAndAppendCard
		function createAndAppendCard(cityName, countryName) {
			// 1. 處理參數：如果 countryName 沒傳，就預設 "自訂"
			// 如果 cityName 裡面包含 "|" (例如 "Tokyo|Japan")，就自動拆解
			if (!countryName && cityName.includes('|')) {
				const parts = cityName.split('|');
				cityName = parts[0];
				countryName = parts[1];
			}

			// 如果還是空的，就給預設值
			countryName = countryName || "自訂";

			// 2. 建立資料 Key (包含國家以防重複，例如 倫敦|英國 vs 倫敦|加拿大)
			const dataVal = `${cityName}|${countryName}`;

			// 檢查是否已存在 (避免重複新增)
			// 這裡同時檢查 "City" 和 "City|Country" 兩種格式
			if (document.querySelector(`.location-card[data-val='${cityName}']`) ||
				document.querySelector(`.location-card[data-val='${dataVal}']`)) {
				return;
			}

			const grid = document.getElementById('locationGrid');
			const newCard = document.createElement('div');

			// 加上 selected 樣式
			newCard.className = "location-card selected";
			newCard.setAttribute("data-val", dataVal);

			// 點擊事件 (取消選取)
			newCard.onclick = function() { toggleSelection(dataVal, this); };

			// ★ 這裡顯示動態的國家名稱，不再是 "自訂"
			newCard.innerHTML = `
				<div class="loc-city">${cityName}</div>
				<div class="loc-country">${countryName}</div>
			`;

			// 插入到最前面
			grid.insertBefore(newCard, grid.firstChild);

			// 加入已選取清單
			selectedLocationNames.add(dataVal);
		}

		function goToCalendar() {
			 window.location.href = `/Match/CalendarCheck/${groupId}`;
		}
	</script>
	<script src="https://maps.googleapis.com/maps/api/js?key=@Configuration["GoogleMaps:ApiKey"]&libraries=places&callback=initAutocomplete" async defer></script>
</body>
</html>