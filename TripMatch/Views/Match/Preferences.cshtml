@model TripMatch.Models.DTOs.TimeWindow.PreferencesViewModel
@using Microsoft.Extensions.Configuration
@inject IConfiguration Configuration
@{
	ViewData["Title"] = "團隊規劃";
	Layout = "~/Views/Shared/_Layout-copy.cshtml";
}

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>@ViewData["Title"]</title>
	<style>
		:root {
			--bg-color: #F3F8FF;
			--card-bg: #FFFFFF;
			--primary-blue: #155DFC;
			--primary-blue-hover: #104AB8;
			--text-main: #111827;
			--text-sub: #6B7280;
			--border-color: #E5E7EB;
			--success-green: #16A34A;
			--shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
			--radius-card: 16px;
			--radius-btn: 12px;
			--font-family: system-ui, -apple-system, sans-serif;
		}

		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}

		body {
			background-color: var(--bg-color);
			font-family: var(--font-family);
			color: var(--text-main);
			padding-bottom: 40px;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 0 24px;
		}

		.icon {
			width: 20px;
			height: 20px;
			display: inline-block;
			vertical-align: middle;
			stroke-width: 2;
		}

		.app-bar {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 20px 0;
			margin-bottom: 10px;
		}

		.back-link {
			text-decoration: none;
			color: var(--text-main);
			font-weight: 600;
			display: flex;
			align-items: center;
			gap: 6px;
		}

		.btn {
			display: inline-flex;
			align-items: center;
			gap: 8px;
			padding: 10px 20px;
			border-radius: var(--radius-btn);
			border: none;
			font-weight: 600;
			cursor: pointer;
			transition: 0.2s;
			white-space: nowrap;
		}

		.btn-primary {
			background-color: var(--primary-blue);
			color: white;
		}

			.btn-primary:hover {
				background-color: var(--primary-blue-hover);
			}

		.btn-success {
			background-color: var(--success-green);
			color: white;
		}

		.header-card {
			background: var(--card-bg);
			border-radius: var(--radius-card);
			box-shadow: var(--shadow);
			padding: 24px 32px;
			display: flex;
			flex-wrap: wrap;
			justify-content: space-between;
			align-items: center;
			gap: 20px;
			margin-bottom: 30px;
		}

		.header-info h1 {
			font-size: 24px;
			font-weight: 700;
			margin-bottom: 8px;
		}

		.invite-code {
			color: var(--text-sub);
			font-size: 14px;
		}

			.invite-code span {
				color: var(--primary-blue);
				font-weight: 600;
				text-decoration: underline;
				cursor: pointer;
			}

		.header-stats {
			display: flex;
			gap: 32px;
			align-items: center;
		}

		.stat-item {
			text-align: center;
		}

		.stat-num {
			font-size: 24px;
			font-weight: 800;
			line-height: 1.2;
		}

		.status-badge {
			background-color: #FEF3C7;
			color: #B45309;
			padding: 6px 16px;
			border-radius: 99px;
			font-weight: 600;
			font-size: 14px;
		}

		.tabs-container {
			display: flex;
			justify-content: center;
			background: var(--card-bg);
			padding: 6px;
			border-radius: 99px;
			box-shadow: 0 1px 3px rgba(0,0,0,0.05);
			margin-bottom: 30px;
			max-width: 500px;
			margin-left: auto;
			margin-right: auto;
		}

		.tab-btn {
			flex: 1;
			display: flex;
			gap: 8px;
			align-items: center;
			justify-content: center;
			padding: 12px 24px;
			border-radius: 99px;
			border: none;
			background: transparent;
			color: var(--text-sub);
			font-weight: 600;
			cursor: pointer;
			transition: 0.3s;
			font-size: 16px;
		}

			.tab-btn.active {
				background-color: var(--primary-blue);
				color: white;
				box-shadow: 0 4px 6px -1px rgba(21, 93, 252, 0.3);
			}

		.tab-content {
			display: none;
			animation: fadeIn 0.3s ease-in-out;
		}

			.tab-content.active {
				display: block;
			}

		@@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(5px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		/* Tab A */
		.input-group {
			display: flex;
			gap: 12px;
			margin-bottom: 32px;
			background: var(--card-bg);
			padding: 16px;
			border-radius: var(--radius-card);
			box-shadow: var(--shadow);
		}

		.input-field {
			flex: 1;
			padding: 12px 16px;
			border: 1px solid var(--border-color);
			border-radius: var(--radius-btn);
			font-size: 16px;
			outline: none;
		}

			.input-field:focus {
				border-color: var(--primary-blue);
				box-shadow: 0 0 0 3px rgba(21, 93, 252, 0.1);
			}

		.location-grid {
			display: grid;
			grid-template-columns: repeat(4, 1fr);
			gap: 20px;
		}

		.location-card {
			background: var(--card-bg);
			border: 2px solid var(--border-color);
			border-radius: var(--radius-card);
			padding: 20px;
			cursor: pointer;
			position: relative;
			transition: 0.2s;
			display: flex;
			flex-direction: column;
			justify-content: center;
			height: 120px;
		}

			.location-card:hover {
				border-color: #CBD5E1;
				transform: translateY(-2px);
			}

			.location-card.selected {
				border-color: var(--primary-blue);
				background-color: #EFF6FF;
				box-shadow: 0 0 0 1px var(--primary-blue);
			}

		.loc-city {
			font-size: 18px;
			font-weight: 700;
			margin-bottom: 4px;
			color: var(--text-main);
		}

		.loc-country {
			font-size: 14px;
			color: var(--text-sub);
		}

		.location-card:hover {
			opacity: 1;
		}

		/* Tab B */
		.pref-card {
			background: var(--card-bg);
			border-radius: var(--radius-card);
			box-shadow: var(--shadow);
			padding: 32px;
			max-width: 800px;
			margin: 0 auto;
		}

		.pref-header {
			display: flex;
			align-items: center;
			gap: 12px;
			margin-bottom: 24px;
			padding-bottom: 16px;
			border-bottom: 1px solid var(--border-color);
		}

		.form-group {
			margin-bottom: 24px;
		}

		.form-label {
			display: block;
			margin-bottom: 8px;
			font-weight: 600;
			font-size: 15px;
		}

		.required {
			color: #EF4444;
			margin-left: 4px;
		}

		.form-select {
			width: 100%;
			padding: 12px 16px;
			border: 1px solid var(--border-color);
			border-radius: var(--radius-btn);
			font-size: 16px;
			background-color: #fff;
			outline: none;
			cursor: pointer;
			appearance: none;
			background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236B7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
			background-repeat: no-repeat;
			background-position: right 16px center;
			background-size: 16px;
		}

		.btn-full {
			width: 100%;
			padding: 14px;
			font-size: 16px;
			border-radius: var(--radius-btn);
			margin-top: 10px;
		}

		@@media (max-width: 1024px) {
			.location-grid {
				grid-template-columns: repeat(3, 1fr);
			}
		}

		@@media (max-width: 768px) {
			.container {
				padding: 0 16px;
			}

			.header-card {
				flex-direction: column;
				align-items: flex-start;
			}

			.header-stats {
				width: 100%;
				justify-content: space-between;
				margin-top: 10px;
			}

			.tabs-container {
				width: 100%;
			}

			.input-group {
				flex-direction: column;
			}

			.location-grid {
				grid-template-columns: repeat(2, 1fr);
			}
		}

		@@media (max-width: 480px) {
			.location-grid {
				grid-template-columns: 1fr;
			}

			.app-bar .btn span {
				display: none;
			}
		}
		/* Autocomplete 樣式整合 */
		.autocomplete-results {
			position: absolute;
			z-index: 1000;
			width: 100%;
			max-height: 300px;
			overflow-y: auto;
			display: none;
			box-shadow: 0 4px 6px rgba(0,0,0,0.1);
			margin-top: 2px;
			padding-left: 0;
			background: white;
			border: 1px solid #ddd;
			border-radius: 0 0 8px 8px;
		}

		/* 修改：加入 flex: 1 確保在 input-group 裡佔滿剩餘空間 */
		.position-relative-container {
			position: relative;
			flex: 1;
		}

		.cursor-pointer {
			cursor: pointer;
		}
	</style>
</head>
<body>
	<div class="container">
		<header class="app-bar">
			<a href="@Url.Action("Index", "Home")" class="back-link">
				<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
					<line x1="19" y1="12" x2="5" y2="12"></line>
					<polyline points="12 19 5 12 12 5"></polyline>
				</svg>
				返回首頁
			</a>
		</header>

		<section class="header-card">
			<div class="header-info">
				<h1>團隊規劃討論</h1>
				<p class="invite-code">邀請碼：<span>@Model.InviteCode</span></p>
			</div>
			<div class="header-stats">
				<div class="stat-item">
					<span class="status-badge">偏好設定階段</span>
				</div>
			</div>
			<div class="stat-item">
				<div style="font-size: 12px; color: var(--text-sub); margin-bottom: 2px;">加入人數</div>
				<div class="stat-num">@Model.JoinedCount / @Model.TargetNumber</div>
			</div>

			<div class="stat-item">
				<div style="font-size: 12px; color: var(--text-sub); margin-bottom: 2px;">已提交</div>
				<div class="stat-num" style="color: @(Model.SubmittedCount == Model.JoinedCount ? "var(--success-green)" : "var(--primary-blue)")">
					@Model.SubmittedCount / @Model.TargetNumber
				</div>
			</div>
		</section>

		<nav class="tabs-container">
			<button class="tab-btn active" onclick="switchTab('tabA')" id="btn-tabA">
				<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
				候選地點
			</button>
			<button class="tab-btn" onclick="switchTab('tabB')" id="btn-tabB">
				<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
				個人偏好設定
			</button>
		</nav>

		<div id="tabA" class="tab-content active">
			<div style="margin-bottom: 24px;">
				<h2 style="font-size: 20px; font-weight: 700; margin-bottom: 6px;">候選地點池</h2>
				<p style="color: var(--text-sub); font-size: 15px;">請選擇想去的地點，系統將以此生成方案</p>
			</div>

			<div class="input-group">
				<div class="position-relative-container">
					<input type="text"
						   id="newLocationInput"
						   class="input-field"
						   style="width: 100%; border-radius: 12px 0 0 12px;"
						   placeholder="搜尋機場代碼 (如：TPE)"
						   autocomplete="off">

					<ul id="LocationResults" class="autocomplete-results list-group"></ul>
				</div>

				<button type="button" class="btn btn-success" onclick="addCustomLocation()" style="border-radius: 0 12px 12px 0;">
					新增
				</button>
			</div>

			<div id="locationGrid" class="location-grid">

				<div class="location-card" onclick="toggleSelection('TPE', this)" data-val="TPE">
					<div class="loc-city">台北</div>
					<div class="loc-country">台灣 (桃園 TPE)</div>
				</div>

				<div class="location-card" onclick="toggleSelection('NRT', this)" data-val="NRT">
					<div class="loc-city">東京</div>
					<div class="loc-country">成田機場 (NRT)</div>
				</div>

				<div class="location-card" onclick="toggleSelection('KIX', this)" data-val="KIX">
					<div class="loc-city">大阪</div>
					<div class="loc-country">關西機場 (KIX)</div>
				</div>

				<div class="location-card" onclick="toggleSelection('ICN', this)" data-val="ICN">
					<div class="loc-city">首爾</div>
					<div class="loc-country">仁川機場 (ICN)</div>
				</div>

				<div class="location-card" onclick="toggleSelection('BKK', this)" data-val="BKK">
					<div class="loc-city">曼谷</div>
					<div class="loc-country">蘇凡納布 (BKK)</div>
				</div>

				<div class="location-card" onclick="toggleSelection('SIN', this)" data-val="SIN">
					<div class="loc-city">新加坡</div>
					<div class="loc-country">樟宜機場 (SIN)</div>
				</div>

				<div class="location-card" onclick="toggleSelection('HKG', this)" data-val="HKG">
					<div class="loc-city">香港</div>
					<div class="loc-country">赤鱲角機場 (HKG)</div>
				</div>

				<div class="location-card" onclick="toggleSelection('LHR', this)" data-val="LHR">
					<div class="loc-city">倫敦</div>
					<div class="loc-country">希斯洛 (LHR)</div>
				</div>

				<div class="location-card" onclick="toggleSelection('JFK', this)" data-val="JFK">
					<div class="loc-city">紐約</div>
					<div class="loc-country">甘迺迪機場 (JFK)</div>
				</div>

				<div class="location-card" onclick="toggleSelection('LAX', this)" data-val="LAX">
					<div class="loc-city">洛杉磯</div>
					<div class="loc-country">洛杉磯機場 (LAX)</div>
				</div>

				<div class="location-card" onclick="toggleSelection('SFO', this)" data-val="SFO">
					<div class="loc-city">舊金山</div>
					<div class="loc-country">舊金山機場 (SFO)</div>
				</div>

				<div class="location-card" onclick="toggleSelection('AMS', this)" data-val="AMS">
					<div class="loc-city">阿姆斯特丹</div>
					<div class="loc-country">史基浦機場 (AMS)</div>
				</div>

				<div class="location-card" onclick="toggleSelection('SYD', this)" data-val="SYD">
					<div class="loc-city">雪梨</div>
					<div class="loc-country">金斯福德 (SYD)</div>
				</div>

				<div class="location-card" onclick="toggleSelection('DXB', this)" data-val="DXB">
					<div class="loc-city">杜拜</div>
					<div class="loc-country">杜拜機場 (DXB)</div>
				</div>

			</div>
		</div>

		<div id="tabB" class="tab-content">
			<div style="margin-bottom: 24px;">
				<h2 style="font-size: 20px; font-weight: 700; margin-bottom: 6px;">個人偏好設定</h2>
				<p style="color: var(--text-sub); font-size: 15px;">填寫您的個人偏好，系統將綜合所有成員意見進行推薦</p>
			</div>

			<div class="pref-card">
				<form id="prefForm" onsubmit="savePreferences(event)">
					<div class="form-group">
						<label class="form-label">飯店預算（每晚）<span class="required">*</span></label>
						<select id="budget" name="budget" class="form-select" required>
							<option value="" disabled selected>請選擇預算範圍</option>
							<option value="1000">NT$ 1,000 以下</option>
							<option value="2500">NT$ 2,500 左右</option>
							<option value="4000">NT$ 4,000 左右</option>
							<option value="5000">NT$ 5,000 以上</option>
						</select>
					</div>

					<div class="form-group">
						<label class="form-label">轉機偏好 <span class="required">*</span></label>
						<select id="transfer" name="transfer" class="form-select" required>
							<option value="" disabled selected>請選擇轉機偏好</option>
							<option value="true">可接受轉機</option>
							<option value="false">不可轉機（直飛）</option>
						</select>
					</div>

					<div class="form-group">
						<label class="form-label">飯店星等偏好 <span class="required">*</span></label>
						<select id="stars" name="stars" class="form-select" required>
							<option value="" disabled selected>請選擇星等</option>
							<option value="3">3 星級以上</option>
							<option value="4">4 星級以上</option>
							<option value="5">5 星級</option>
							<option value="flex">彈性 (無所謂)</option>
						</select>
					</div>
					<div class="form-group">
						<label class="form-label">個人行程總預算<span class="required">*</span></label>
						<input type="number" id="totalBudget" name="totalBudget" class="input-field" required placeholder="請輸入總預算 (NT$)">
					</div>

					<button type="submit" class="btn btn-primary btn-full" id="btnSubmit">
						儲存我的偏好
					</button>
				</form>
			</div>
		</div>
	</div>

	@section Scripts {
		<script src="~/js/flight-autocomplete.js"></script>

		<script>
			const groupId = '@Model.GroupId';
			let selectedLocationNames = new Set();

			document.addEventListener("DOMContentLoaded", function() {
				// 2. 初始化自動補全 (對應上面的 ID)
				if (typeof initFlightAutocomplete === 'function') {
					initFlightAutocomplete('newLocationInput', 'LocationResults');
				}

				// 還原已儲存的地點
				const savedLocs = @Html.Raw(Json.Serialize(Model.MySelectedLocations));
				if (savedLocs && savedLocs.length > 0) {
					savedLocs.forEach(cityName => {
						selectedLocationNames.add(cityName);
						// 嘗試找到對應的熱門卡片
						const existingCard = document.querySelector(`.location-card[data-val='${cityName}']`);
						if (existingCard) {
							existingCard.classList.add('selected');
						} else {
							// 如果不是熱門地點，就作為自訂卡片還原
							restoreCustomCard(cityName);
						}
					});
				}
			});

			function switchTab(tabId) {
				document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
				document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
				document.getElementById('btn-' + tabId).classList.add('active');
				document.getElementById(tabId).classList.add('active');
			}

			function toggleSelection(cityName, cardElement) {
				if (cardElement.classList.contains('selected')) {
					cardElement.classList.remove('selected');
					selectedLocationNames.delete(cityName);
				} else {
					cardElement.classList.add('selected');
					selectedLocationNames.add(cityName);
				}
			}

			function addCustomLocation() {
				const input = document.getElementById('newLocationInput');
				const code = input.value.trim(); // 這是 TPE

				if (!code) { alert("請輸入地點或代碼"); return; }

				// ★ 修改開始：優先從 dataset 讀取 API 查到的名稱
				// 如果 dataset 有值 (代表是從選單點選的)，就用 dataset.name (例如 "台北")
				// 如果 dataset 沒值 (代表是使用者手打的)，就用輸入框的值 (例如 "TPE")
				let displayCity = input.dataset.name || code;
				let displayCountry = input.dataset.country || "自訂";

				// 為了顯示清楚，我們可以組合成 "台灣 (TPE)" 這樣的格式
				// 只有當 displayCountry 不是 "自訂" 時才加上代碼，避免重複顯示
				if (input.dataset.country) {
					displayCountry = `${displayCountry} (${code})`;
				} else {
					// 如果是手打的，為了卡片資料一致性，這裡也可以處理一下
					displayCountry = `自訂 (${code})`;
				}

				// 呼叫建立卡片 (這裡傳入的是漂亮的名字)
				// 注意：我們雖然顯示漂亮名字，但 data-val 還是要用 code 避免重複
				createAndAppendCard(displayCity, displayCountry, code);

				// ★ 重要：清空輸入框的同時，也要清空 dataset，避免下一次輸入殘留舊資料
				input.value = "";
				delete input.dataset.name;
				delete input.dataset.country;
			}

			function restoreCustomCard(val) {
				createAndAppendCard(val);
			}

						function createAndAppendCard(cityName, countryName, code) {
				// 如果沒有傳入 code (例如是還原舊資料時)，就用 cityName 當作 code 的防呆
				// 但通常我們在 addCustomLocation 都會傳 code 進來
				const dataVal = code || cityName;

				// 檢查重複 (使用 dataVal / Code 來檢查)
				const allCards = Array.from(document.querySelectorAll('.location-card'));
				const isDuplicate = allCards.some(card => {
					const val = card.getAttribute('data-val');
					return val === dataVal;
				});

				if (isDuplicate) {
					alert(`這個地點 (${dataVal}) 已經在清單中了！`);
					return;
				}

				// 建立 DOM
				const grid = document.getElementById('locationGrid');
				const newCard = document.createElement('div');
				newCard.className = "location-card selected";

				// ★ 這裡存的是純代碼 (TPE)，給後端用的
				newCard.setAttribute("data-val", dataVal);

				newCard.onclick = function() { toggleSelection(dataVal, this); };

				// ★ 這裡顯示的是漂亮的中文字
				newCard.innerHTML = `
					<div class="loc-city">${escapeHtml(cityName)}</div>
					<div class="loc-country">${escapeHtml(countryName)}</div>
				`;

				// 插入到最前面
				if (grid.firstChild) {
					grid.insertBefore(newCard, grid.firstChild);
				} else {
					grid.appendChild(newCard);
				}

				selectedLocationNames.add(dataVal);
			}

			async function savePreferences(event) {
    event.preventDefault();

    const budgetVal = document.getElementById('budget').value;
    const transferVal = document.getElementById('transfer').value;
    const starsVal = document.getElementById('stars').value;
    const totalBudgetVal = document.getElementById('totalBudget').value;

    if (!budgetVal || !transferVal || !starsVal || !totalBudgetVal) {
        alert("請完成所有必填選項！");
        return;
    }

    const hotelBudget = parseInt(budgetVal, 10);
    const isTransfer = (transferVal === "true");
    const hotelRating = (starsVal === "flex") ? null : parseInt(starsVal, 10);

    const placesString = Array.from(selectedLocationNames).join(",");
    const totalBudget = parseInt(totalBudgetVal, 10);

    const payload = {
        HotelBudget: hotelBudget,
        Transfer: isTransfer,
        HotelRating: hotelRating,
        PlacesToGo: placesString,
        TotalBudget: totalBudget
    };

    const btn = document.getElementById('btnSubmit');
    const originalText = btn ? btn.innerText : '';
    if (btn) { btn.disabled = true; btn.innerText = "儲存中..."; }

    try {
        const response = await fetch(`/api/timewindow/${groupId}/preferences`, {
            method: 'PUT',
            credentials: 'include', // 攜帶 cookie（避免 401）
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': window.csrfToken || '' // 如果需要 CSRF token
            },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            alert("偏好儲存成功！");
            window.location.href = `/Match/CalendarCheck/${groupId}`;
            return;
        }

        // 若非 2xx，嘗試解析後端回傳的錯誤訊息（JSON 或純文字）
        let errText = `狀態碼 ${response.status}`;
        try {
            const j = await response.json();
            errText = j && j.message ? j.message : JSON.stringify(j);
        } catch (jsonErr) {
            try {
                const txt = await response.text();
                if (txt) errText = txt;
            } catch { /* ignore */ }
        }

        alert("儲存失敗: " + errText);
        console.error("savePreferences failed:", response.status, errText);
    } catch (e) {
        console.error("savePreferences network/error:", e);
        alert("連線錯誤，請稍後再試");
    } finally {
        if (btn) { btn.disabled = false; btn.innerText = originalText; }
    }
}

			function escapeHtml(text) {
				if (!text) return text;
				return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
			}

			function goToCalendar() {
				 window.location.href = `/Match/CalendarCheck/${groupId}`;
			}
		</script>
	}
</body>
</html>