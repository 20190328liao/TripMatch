@using TripMatch.Models
@{
    ViewData["Title"] = "確認行程時間";
    Layout = "~/Views/Shared/_Layout-copy.cshtml";

    // --- 後端資料防呆 ---
    bool isSubmitted = (ViewData["IsSubmitted"] as bool?) == true;
    bool hasData = (ViewData["HasCalendarData"] as bool?) == true;
    string groupId = ViewData["GroupId"]?.ToString() ?? "0";
    string isSubmittedJs = isSubmitted.ToString().ToLower();
}

<link rel="stylesheet" href="~/css/Match/CalendarCheck.css" />

<style>
</style>

<div class="page-wrap">
    <div id="selectionSection" class="@(isSubmitted ? "d-none" : "")">
        <div class="calendar-container">
            <h2 class="text-center fw-bold mb-2" style="color:var(--text-dark)">確認您的可用時間</h2>
            <p class="text-center text-muted mb-4">系統已自動帶入您在會員中心的設定，請確認本次行程的可用時段</p>

            <div id="groupRangeInfo" class="text-center mb-4 d-none" style="font-size:0.95rem; color:var(--text-muted)">
                揪團期間：尚未設定
            </div>

            <div class="calendar-legend">
                <div class="legend-item"><span class="legend-marker marker-today"></span><span>今天</span></div>
                <div class="legend-item"><span class="legend-marker marker-locked"></span><span>非揪團期間</span></div>
                <div class="legend-item"><span class="legend-marker marker-selected"></span><span>已選取</span></div>
                <div class="legend-item"><span class="legend-marker marker-joinable"></span><span>我可以參加</span></div>
            </div>

            <div class="row g-4">
                <div class="col-lg-3 col-md-4">
                    <div class="side-panel">
                        <div class="year-header">
                            <button class="year-left nav-btn">◀</button>
                            <div class="year-display">2026</div>
                            <button class="year-right nav-btn">▶</button>
                        </div>
                        <div class="months-grid mb-4"></div>
                        <hr style="border-color:#eee" />
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0 fw-bold" style="color:var(--dark-mint)">已選時段</h6>
                            <span class="badge rounded-pill" style="background:var(--accent); font-size:0.9rem" id="selectedCount">0</span>
                        </div>
                        <div class="list-scroll-area">
                            <div id="calendarList" class="d-flex flex-column gap-2"></div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-9 col-md-8">
                    <div class="month-header mb-3">
                        <button class="month-left nav-btn">◀</button>
                        <div class="month-display">January 2026</div>
                        <button class="month-right nav-btn">▶</button>
                    </div>
                    <div class="week-header">
                        <div>週一</div><div>週二</div><div>週三</div><div>週四</div><div>週五</div><div>週六</div><div style="color:#ef4444">週日</div>
                    </div>
                    <div class="days"></div>
                </div>
            </div>

            <div class="row mt-5">
                <div class="col-12 text-center">
                    <button id="btnSubmit" onclick="submitSlots()" class="btn btn-submit-custom btn-lg">
                        <span class="btn-main-text">確認提交</span>
                        <span class="btn-sub-text">下一步</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="waitingSection" class="@(isSubmitted ? "" : "d-none")" style="text-align: center; padding: 60px 20px;">
        <div class="calendar-container" style="max-width: 600px; margin: 0 auto;">
            <div class="mb-4 pt-4">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem; color:var(--primary-mint) !important;" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <h3 class="fw-bold text-dark mb-3">時間已鎖定 🔒</h3>
            <p class="text-muted mb-4">您已完成提交！正在等待其他夥伴...<br>全員完成後，系統將自動跳轉至結果頁。</p>
            <div class="bg-light px-4 py-2 rounded-pill d-inline-block mb-4">
                目前狀態：<span id="progressText" class="fw-bold" style="color:var(--dark-mint)">連線中...</span>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="calendarModal">
    <div class="custom-modal">
        <div class="modal-top-icon">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zm-7 5h5v5h-5v-5z" /></svg>
        </div>

        <h2 class="modal-title">設定你的行事曆</h2>
        <p class="modal-subtitle">同步您的行事曆，讓時間媒合更快速、更準確</p>

        <div class="feature-box">
            <div class="feature-item">
                <div class="feature-icon icon-blue">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z" /></svg>
                </div>
                <div class="feature-text">
                    <h4>自動偵測可用時間</h4>
                    <p>系統會自動分析您的行事曆，標示出可以出發的日期</p>
                </div>
            </div>
            <div class="feature-item">
                <div class="feature-icon icon-green">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 9l1.25-2.75L23 5l-2.75-1.25L19 1l-1.25 2.75L15 5l2.75 1.25L19 9zm-7.5.5L9 6 6.5 9.5 3 12l3.5 2.5L9 18l2.5-3.5L15 12l-3.5-2.5zM19 15l-1.25 2.75L15 19l2.75 1.25L19 23l1.25-2.75L23 19l-2.75-1.25L19 15z" /></svg>
                </div>
                <div class="feature-text">
                    <h4>一次設定，永久使用</h4>
                    <p>之後每次時間媒合都可以直接帶入，省去重複設定的麻煩</p>
                </div>
            </div>
            <div class="feature-item">
                <div class="feature-icon icon-purple">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" /></svg>
                </div>
                <div class="feature-text">
                    <h4>提高協調效率</h4>
                    <p>減少人工輸入錯誤，讓團隊更快找到共同時間</p>
                </div>
            </div>
        </div>

        <div class="d-grid">
            <button id="btnImportFromCheck" class="btn btn-primary-mint">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10z" /></svg>
                匯入個人行事曆
            </button>
            <button id="closeModal" class="btn btn-secondary-light">
                先跳過，稍後再設定
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/AuthApi/Datehelper.js" asp-append-version="true"></script>
    <script src="~/js/AuthApi/calendar-ui.js" asp-append-version="true"></script>
    <script src="~/js/AuthApi/calendar-plugin.js" asp-append-version="true"></script>

    <script>
        const currentGroupId = '@groupId';
        const currentGroupIdInt = parseInt(currentGroupId || '0', 10);
        const recommendationsUrlServer = '@Url.Action("Recommendations", "Match", new { id = (ViewData["GroupId"] ?? 0) })';
        const isSubmittedInit = '@isSubmitted.ToString().ToLower()' === 'true';

        let targetDays = 1;
        let selectedRanges = [];
        let pollingInterval;

        function hasValidGroupId() { return Number.isInteger(currentGroupIdInt) && currentGroupIdInt > 0; }

        function goToMemberCenter() {
            sessionStorage.setItem('calendar_check_pending', JSON.stringify({ groupId: currentGroupId }));
            window.location.href = '/Auth/MemberCenter#calendar_section';
        }

        // 修正：確實隱藏 Modal，包含清除 inline style
        function dismissCalendarModal() {
            sessionStorage.removeItem('calendar_check_pending');
            const modal = document.getElementById('calendarModal');
            if (modal) {
                modal.classList.remove('active');
                modal.style.display = 'none'; // 強制隱藏，覆蓋可能存在的 display:flex
            }
        }

        // --- ★ 修改：引導提示 (改為固定選第一個可用位置) ---
        function initGuideHints() {
            document.querySelectorAll('.guide-highlight').forEach(el => el.classList.remove('guide-highlight'));
            const availableCells = Array.from(document.querySelectorAll('.day-cell:not(.empty):not(.locked)'));

            if (availableCells.length > 0) {
                const target = availableCells[0];
                target.classList.add('guide-highlight');
                const removeHint = () => {
                    target.classList.remove('guide-highlight');
                    target.removeEventListener('mousedown', removeHint);
                    target.removeEventListener('mouseenter', removeHint);
                };
                target.addEventListener('mousedown', removeHint);
                target.addEventListener('mouseenter', removeHint);
            }
        }

        document.addEventListener('calendarui:dismissHints', () => {
            document.querySelectorAll('.guide-highlight').forEach(el => el.classList.remove('guide-highlight'));
        });

        // --- 渲染清單 ---
        function renderList() {
            const $list = document.getElementById('calendarList');
            const $count = document.getElementById('selectedCount');
            if (!$list) return;

            selectedRanges.sort((a, b) => a.start.localeCompare(b.start));

            if (selectedRanges.length === 0) {
                $list.innerHTML = '<div class="text-muted text-center mt-3 fs-7">尚無選取區段</div>';
                if($count) $count.textContent = '0';
                return;
            }

            $list.innerHTML = selectedRanges.map(r => {
                const isEnough = r.days >= targetDays;
                return `
                <div class="calendar-list-item ${isEnough ? '' : 'border-danger'}">
                    <div>
                        <div class="fw-bold ${r.valid ? 'text-success' : 'text-danger'}" style="font-size:0.95rem">
                            ${r.start.slice(5)} ~ ${r.end.slice(5)}
                        </div>
                        <small class="${isEnough ? 'text-muted' : 'text-danger fw-bold'}" style="font-size:0.85rem">
                            ${r.days} 天 (${isEnough ? '符合需求' : '天數不足'})
                        </small>
                    </div>
                    <button class="btn btn-sm btn-light text-danger border-0 rounded-circle" style="width:30px;height:30px;" onclick="window.removeRange('${r.start}')">✕</button>
                </div>`;
            }).join('');
            if($count) $count.textContent = selectedRanges.filter(r => r.valid).length;
        }

        window.removeRange = function(startIso) {
            const idx = selectedRanges.findIndex(r => r.start === startIso);
            if(idx >= 0) {
                selectedRanges.splice(idx, 1);
                if(window._tripmatch_calendar_instance?.render) window._tripmatch_calendar_instance.render();
                else renderList();
            }
        };

        // --- 提交與狀態 ---
        async function submitSlots() {
            if (!hasValidGroupId()) { alert('無效的揪團 ID'); return; }
            const validRanges = selectedRanges.filter(r => r.valid);
            if (validRanges.length === 0) { alert("沒有符合天數要求的時段！"); return; }
            if (!confirm(`提交 ${validRanges.length} 個時段？`)) return;

            const slots = validRanges.map(r => ({ startAt: r.start + "T00:00:00", endAt: r.end + "T23:59:59" }));
            const btn = document.getElementById('btnSubmit');
            if (btn) btn.disabled = true;

            try {
                const res = await fetch(`/api/timewindow/${encodeURIComponent(currentGroupId)}/available`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(slots)
                });
                if (res.ok) {
                    sessionStorage.removeItem('calendar_draft_ranges');
                    showWaitingMode();
                } else {
                    alert("提交失敗");
                    if (btn) btn.disabled = false;
                }
            } catch (e) { alert("連線錯誤"); if (btn) btn.disabled = false; }
        }

        function showWaitingMode() {
            document.getElementById('selectionSection')?.classList.add('d-none');
            document.getElementById('waitingSection')?.classList.remove('d-none');
            if (hasValidGroupId()) checkStatus();
            pollingInterval = setInterval(() => { if (hasValidGroupId()) checkStatus(); }, 3000);
        }

        async function checkStatus() {
            try {
                const res = await fetch(`/api/timewindow/${currentGroupId}/status`);
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('progressText').innerText = `${data.submittedCount} / ${data.memberCount} 人已提交`;
                    if (data.status === "COMPLETED") {
                        clearInterval(pollingInterval);
                        window.location.href = `/Match/Recommendations/${currentGroupId}`;
                    }
                }
            } catch(e) {}
        }

        // --- 行事曆核心 ---
        async function initCalendar() {
            let currentYear = new Date().getFullYear();
            let currentMonth = new Date().getMonth();
            let groupStart = null, groupEnd = null;
            let myLeaveDates = new Set();
            let pendingStartDate = null;
            const todayIso = new Date().toISOString().split('T')[0];

            let isDragging = false;
            let anchorDate = null;

            window._tripmatch_calendar_instance = {
                render: function() { renderMonth(); renderList(); },
                importRanges: function(ranges) {
                    if (!Array.isArray(ranges)) return;
                    ranges.forEach(r => {
                        let s = (r.startAt || r.start).slice(0, 10);
                        let e = (r.endAt || r.end).slice(0, 10);
                        if (groupStart && s < groupStart) s = groupStart;
                        if (groupEnd && e > groupEnd) e = groupEnd;
                        if (s > e) return;
                        if (checkOverlap(s, e)) return;

                        const dayCount = Math.round((new Date(e) - new Date(s)) / 86400000) + 1;
                        selectedRanges.push({ start: s, end: e, days: dayCount, valid: dayCount >= targetDays });
                    });
                    renderMonth();
                    renderList();
                }
            };

            await Promise.all([loadGroupInfo(), loadMyAvailability()]);
            await loadMyExistingSlots();
            loadImportedDraft();

            document.querySelector('.days')?.addEventListener('mouseleave', clearPreview);
            document.addEventListener('mouseup', handleGlobalMouseUp);

            buildMonthPanel();
            renderMonth();
            bindCalendarEvents();

            async function loadGroupInfo() {
                const res = await fetch(`/api/timewindow/${currentGroupId}/status`);
                if(res.ok) {
                    const data = await res.json();
                    groupStart = (data.dateStart || "").split('T')[0];
                    groupEnd = (data.dateEnd || "").split('T')[0];
                    targetDays = data.travelDays || 3;
                    if (groupStart) {
                        const d = new Date(groupStart);
                        currentYear = d.getFullYear(); currentMonth = d.getMonth();
                    }
                    document.getElementById('groupRangeInfo').innerHTML = `揪團期間：<strong>${groupStart}</strong> ～ <strong>${groupEnd}</strong> • 行程需 ${targetDays} 天`;
                    document.getElementById('groupRangeInfo').classList.remove('d-none');
                }
            }
            async function loadMyAvailability() {
                const res = await fetch('/api/auth/GetLeaves');
                if(res.ok) {
                    const data = await res.json();
                    if(data.dates) data.dates.forEach(d => myLeaveDates.add(d));
                }
            }
            async function loadMyExistingSlots() {
                const res = await fetch(`/api/timewindow/${currentGroupId}/available`, { credentials: 'include' });
                if (res.ok) {
                    const data = await res.json();
                    if (data.slots && data.slots.length > 0) window._tripmatch_calendar_instance.importRanges(data.slots);
                }
            }
            function loadImportedDraft() {
                const raw = sessionStorage.getItem('calendar_draft_ranges');
                if (raw) {
                    const draft = JSON.parse(raw);
                    if (draft.groupId == currentGroupId && Array.isArray(draft.ranges)) window._tripmatch_calendar_instance.importRanges(draft.ranges);
                }
            }

            function handleMouseDown(iso, existingRange) {
                document.dispatchEvent(new CustomEvent('calendarui:dismissHints'));
                isDragging = true;
                if (existingRange) {
                    const idx = selectedRanges.indexOf(existingRange);
                    if (idx > -1) selectedRanges.splice(idx, 1);
                    if (iso === existingRange.start) anchorDate = existingRange.end;
                    else if (iso === existingRange.end) anchorDate = existingRange.start;
                    else anchorDate = iso;
                } else {
                    anchorDate = iso;
                }
                renderMonth();
                handleMouseOver(iso);
            }

            function handleMouseOver(hoverIso) {
                if (!isDragging || !anchorDate) return;
                clearPreview();
                const start = anchorDate < hoverIso ? anchorDate : hoverIso;
                const end = anchorDate < hoverIso ? hoverIso : anchorDate;
                const dayCount = calculateDays(start, end);
                const isOverlap = checkOverlap(start, end);
                const hasLocked = checkRangeHasLocked(start, end);
                const isValid = (dayCount >= targetDays) && !isOverlap && !hasLocked;
                const previewClass = isValid ? 'preview-valid' : 'preview-invalid';
                document.querySelectorAll('.day-cell:not(.empty)').forEach(cell => {
                    const iso = cell.dataset.iso;
                    if (iso >= start && iso <= end) {
                        cell.classList.add(previewClass);
                        if (iso === start) cell.classList.add('preview-start');
                        if (iso === end) cell.classList.add('preview-end');
                    }
                });
            }

            function handleGlobalMouseUp() {
                if (!isDragging) return;
                isDragging = false;
                const startCell = document.querySelector('.day-cell.preview-start');
                const endCell = document.querySelector('.day-cell.preview-end');
                if (startCell && endCell) {
                    const s = startCell.dataset.iso;
                    const e = endCell.dataset.iso;
                    if (!checkOverlap(s, e) && !checkRangeHasLocked(s, e)) {
                        const dayCount = calculateDays(s, e);
                        selectedRanges.push({ start: s, end: e, days: dayCount, valid: dayCount >= targetDays });
                    }
                }
                anchorDate = null;
                clearPreview();
                renderMonth();
            }

            function clearPreview() {
                document.querySelectorAll('.day-cell').forEach(cell => {
                    cell.classList.remove('preview-valid', 'preview-invalid', 'preview-start', 'preview-end');
                });
            }

            function isLocked(iso) {
                if (!groupStart || !groupEnd) return true;
                return iso < groupStart || iso > groupEnd;
            }
            function checkOverlap(start, end) {
                return selectedRanges.some(r => !(end < r.start || start > r.end));
            }
            function calculateDays(start, end) { return Math.round((new Date(end) - new Date(start)) / 86400000) + 1; }
            function checkRangeHasLocked(start, end) {
                let curr = new Date(start); const last = new Date(end);
                while(curr <= last) {
                    const z = curr.getTimezoneOffset() * 60 * 1000;
                    const iso = new Date(curr - z).toISOString().split('T')[0];
                    if(isLocked(iso)) return true; curr.setDate(curr.getDate() + 1);
                }
                return false;
            }
            function getDateRangeStatus(iso) {
                for (let range of selectedRanges) {
                    if (iso === range.start && iso === range.end) return { type: 'single', isValid: range.valid, range: range };
                    if (iso > range.start && iso < range.end) return { type: 'mid', isValid: range.valid, range: range };
                    if (iso === range.start) return { type: 'start', isValid: range.valid, range: range };
                    if (iso === range.end) return { type: 'end', isValid: range.valid, range: range };
                }
                return null;
            }

            function renderMonth() {
                const $days = document.querySelector('.days');
                const $monthDisplay = document.querySelector('.month-display');
                const $yearDisplay = document.querySelector('.year-display');
                if (!$days) return;

                const firstDay = new Date(currentYear, currentMonth, 1);
                if($monthDisplay) $monthDisplay.textContent = firstDay.toLocaleString('default', { month: 'long', year: 'numeric' });
                if($yearDisplay) $yearDisplay.textContent = currentYear;
                $days.innerHTML = '';

                const startDay = (firstDay.getDay() + 6) % 7;
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

                for(let i=0; i<startDay; i++) { $days.innerHTML += `<div class="day-cell empty"></div>`; }

                for(let d=1; d<=daysInMonth; d++) {
                    const date = new Date(currentYear, currentMonth, d);
                    const z = date.getTimezoneOffset() * 60 * 1000;
                    const iso = new Date(date - z).toISOString().split('T')[0];
                    const cell = document.createElement('div');
                    cell.className = 'day-cell';
                    cell.textContent = d;
                    cell.dataset.iso = iso;

                    if (isLocked(iso)) cell.classList.add('locked');
                    else {
                        if (iso === todayIso) cell.classList.add('today');
                        if (myLeaveDates.has(iso)) cell.classList.add('has-leave');

                        const status = getDateRangeStatus(iso);
                        if (status) {
                            cell.classList.add(status.isValid ? 'status-valid' : 'status-invalid');
                            if (status.type === 'start') cell.classList.add('range-start');
                            if (status.type === 'end') cell.classList.add('range-end');
                            if (status.type === 'mid') cell.classList.add('range-mid');

                            const dot = document.createElement('div');
                            dot.className = 'dot';
                            cell.appendChild(dot);
                        }

                        cell.onmousedown = (e) => {
                            e.preventDefault();
                            handleMouseDown(iso, status ? status.range : null);
                        };
                        cell.onmouseenter = () => handleMouseOver(iso);
                    }
                    $days.appendChild(cell);
                }
                renderList();
            }

            function buildMonthPanel() {
                const $grid = document.querySelector('.months-grid');
                const $yearDisplay = document.querySelector('.year-display');
                if(!$grid) return;
                if($yearDisplay) $yearDisplay.textContent = currentYear;
                $grid.innerHTML = '';
                for(let m=0; m<12; m++) {
                    const btn = document.createElement('div');
                    btn.className = `month-btn ${m === currentMonth ? 'active' : ''}`;
                    btn.innerHTML = `<span style="font-size:1.1em">${m+1}</span>月`;
                    btn.onclick = () => { currentMonth = m; renderMonth(); updateMonthActive(); };
                    $grid.appendChild(btn);
                }
            }
            function updateMonthActive() {
                document.querySelectorAll('.month-btn').forEach((btn, idx) => {
                    btn.classList.toggle('active', idx === currentMonth);
                });
            }
            function bindCalendarEvents() {
                const yearLeft = document.querySelector('.year-left');
                const yearRight = document.querySelector('.year-right');
                const monthLeft = document.querySelector('.month-left');
                const monthRight = document.querySelector('.month-right');
                if(yearLeft) yearLeft.onclick = () => { currentYear--; buildMonthPanel(); renderMonth(); };
                if(yearRight) yearRight.onclick = () => { currentYear++; buildMonthPanel(); renderMonth(); };
                if(monthLeft) monthLeft.onclick = () => { currentMonth--; if(currentMonth < 0) { currentMonth = 11; currentYear--; buildMonthPanel(); } else { updateMonthActive(); } renderMonth(); };
                if(monthRight) monthRight.onclick = () => { currentMonth++; if(currentMonth > 11) { currentMonth = 0; currentYear++; buildMonthPanel(); } else { updateMonthActive(); } renderMonth(); };
            }
        }

        // --- 6. 頁面入口 ---
        document.addEventListener("DOMContentLoaded", async function() {
            const draftRaw = sessionStorage.getItem('calendar_draft_ranges');
            const shouldShowPrompt = "@((bool)(ViewData["ShowCalendarPrompt"] ?? false) ? "true" : "false")" === "true";

            // 綁定事件：避免 HTML onclick 找不到函式
            const importBtn = document.getElementById('btnImportFromCheck');
            if (importBtn) importBtn.addEventListener('click', goToMemberCenter);

            // ★ 修改：手動綁定「先跳過」按鈕，確保事件正確觸發
            const closeBtn = document.getElementById('closeModal');
            if (closeBtn) {
                closeBtn.addEventListener('click', dismissCalendarModal);
            }

            let isDraftValid = false;
            if (draftRaw) {
                try {
                    const draft = JSON.parse(draftRaw);
                    if (draft.groupId == currentGroupId) isDraftValid = true;
                } catch(e) {}
            }

            if (isDraftValid) {
                const modal = document.getElementById('calendarModal');
                if (modal) {
                    modal.classList.remove('active');
                    modal.style.display = 'none';
                }
            } else if (shouldShowPrompt) {
                const modal = document.getElementById('calendarModal');
                if (modal) {
                    modal.classList.add('active');
                    modal.style.display = 'flex';
                }
            }

            if (!hasValidGroupId()) return;

            if (isSubmittedInit) {
                showWaitingMode();
                document.getElementById('calendarModal')?.classList.remove('active');
            } else {
                if (typeof initCalendar === 'function') {
                    await initCalendar();
                    setTimeout(initGuideHints, 600);
                }
            }
        });
    </script>
}